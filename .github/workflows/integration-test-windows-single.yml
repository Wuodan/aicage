name: Integration Tests (Windows Single Job)

"on":
  workflow_dispatch:

jobs:
  integration-windows:
    name: Integration tests on windows-latest
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Install Cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: Syncing metadata and agents with sub-project 'aicage-image'
        shell: bash
        run: |
          scripts/sync-with-aicage-image-projects.sh

      - name: Set up Python
        uses: actions/setup-python@v6.1.0
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: powershell
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements-dev.txt

      - name: Validating config with schemas
        shell: bash
        run: |
          scripts/validate-config-with-schemas.sh

      - name: Prepare WSL2 Linux Docker daemon
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $distros = wsl --list --quiet
          if (-not ($distros -match "^Ubuntu")) {
            wsl --install -d Ubuntu
          }
          wsl --list --verbose
          wsl --set-version Ubuntu 2
          wsl -d Ubuntu -u root -- bash -lc "apt-get update && apt-get install -y docker.io"
          wsl -d Ubuntu -u root -- bash -lc "nohup dockerd -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock > /var/log/dockerd.log 2>&1 &"
          wsl -d Ubuntu -u root -- bash -lc "for i in {1..30}; do docker info >/dev/null 2>&1 && break; sleep 2; done"
          $wslIp = wsl -d Ubuntu -- bash -lc "hostname -I | awk '{print $1}'"
          Add-Content -Path $env:GITHUB_ENV -Value "DOCKER_HOST=tcp://$wslIp:2375"

      - name: Validate Linux Docker engine
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $osType = docker info --format '{{.OSType}}'
          if ($osType -ne "linux") {
            throw "Expected Linux Docker engine, got: $osType"
          }

      - name: Run integration tests
        shell: bash
        env:
          AICAGE_RUN_INTEGRATION: "1"
        run: pytest -m integration --cov=src --cov-report=term-missing
